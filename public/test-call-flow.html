<!DOCTYPE html>
<html>
<head>
    <title>Test Call Flow</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        input, button, select { padding: 8px; margin: 5px; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Test Call Flow</h1>
    
    <div class="container">
        <h2>Firebase Setup</h2>
        <button id="initFirebase">Initialize Firebase</button>
        <button id="checkAuth">Check Auth Status</button>
        <div id="firebaseStatus" class="log">Not initialized</div>
    </div>
    
    <div class="container">
        <h2>Send Test Call</h2>
        <input type="text" id="receiverId" placeholder="Receiver User ID">
        <select id="callType">
            <option value="audio">Audio Call</option>
            <option value="video">Video Call</option>
        </select>
        <input type="text" id="callerName" placeholder="Caller Name" value="Test User">
        <button id="sendCall">Send Test Call</button>
        <div id="sendResult" class="log">Enter receiver ID and click send</div>
    </div>
    
    <div class="container">
        <h2>Listen for Incoming Calls</h2>
        <input type="text" id="currentUserId" placeholder="Current User ID">
        <button id="startListening">Start Listening</button>
        <button id="stopListening">Stop Listening</button>
        <div id="listenResult" class="log">Enter user ID and start listening</div>
    </div>
    
    <div class="container">
        <h2>Call Actions</h2>
        <button id="acceptCall">Accept Call</button>
        <button id="declineCall">Decline Call</button>
        <div id="actionResult" class="log">Perform call actions</div>
    </div>

    <script>
        let database = null;
        let unsubscribe = null;
        let currentCallData = null;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA1x_MWgIJlEB8BToP2Mc7LLAZv0pPjtc8",
            authDomain: "vibe-35004.firebaseapp.com",
            databaseURL: "https://vibe-35004-default-rtdb.firebaseio.com",
            projectId: "vibe-35004",
            storageBucket: "vibe-35004.appspot.com",
            messagingSenderId: "667054799663",
            appId: "1:667054799663:web:849dc655b5ef124d9fffda"
        };

        document.getElementById('initFirebase').addEventListener('click', () => {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                document.getElementById('firebaseStatus').innerHTML = '<span class="success">‚úÖ Firebase initialized successfully</span>';
                document.getElementById('firebaseStatus').className = 'log success';
            } catch (error) {
                document.getElementById('firebaseStatus').innerHTML = '<span class="error">‚ùå Firebase initialization error: ' + error.message + '</span>';
                document.getElementById('firebaseStatus').className = 'log error';
            }
        });

        document.getElementById('checkAuth').addEventListener('click', async () => {
            if (!database) {
                document.getElementById('firebaseStatus').innerHTML = '<span class="error">‚ùå Firebase not initialized</span>';
                return;
            }
            
            try {
                // This is a simplified check - in a real app, you'd use Firebase Auth
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    if (snap.val() === true) {
                        document.getElementById('firebaseStatus').innerHTML = '<span class="success">‚úÖ Firebase connected</span>';
                    } else {
                        document.getElementById('firebaseStatus').innerHTML = '<span class="warning">‚ö†Ô∏è Firebase not connected</span>';
                    }
                });
            } catch (error) {
                document.getElementById('firebaseStatus').innerHTML = '<span class="error">‚ùå Firebase connection error: ' + error.message + '</span>';
            }
        });

        document.getElementById('sendCall').addEventListener('click', async () => {
            if (!database) {
                document.getElementById('sendResult').innerHTML = '<span class="error">‚ùå Firebase not initialized</span>';
                return;
            }
            
            const receiverId = document.getElementById('receiverId').value;
            const callType = document.getElementById('callType').value;
            const callerName = document.getElementById('callerName').value || 'Test User';
            
            if (!receiverId) {
                document.getElementById('sendResult').innerHTML = '<span class="error">‚ùå Please enter receiver ID</span>';
                return;
            }
            
            try {
                const signal = {
                    callerId: 'test_user',
                    callerName: callerName,
                    callType: callType,
                    timestamp: Date.now(),
                    status: 'ringing'
                };
                
                console.log('Sending call signal:', signal);
                
                // Send call signal to receiver
                await database.ref(`calls/${receiverId}/incoming`).set(signal);
                
                document.getElementById('sendResult').innerHTML = 
                    '<span class="success">‚úÖ Call signal sent successfully</span><br>' +
                    'Receiver ID: ' + receiverId + '<br>' +
                    'Call Type: ' + callType;
            } catch (error) {
                document.getElementById('sendResult').innerHTML = '<span class="error">‚ùå Error sending call: ' + error.message + '</span>';
                console.error('Error sending call:', error);
            }
        });

        document.getElementById('startListening').addEventListener('click', () => {
            if (!database) {
                document.getElementById('listenResult').innerHTML = '<span class="error">‚ùå Firebase not initialized</span>';
                return;
            }
            
            const currentUserId = document.getElementById('currentUserId').value;
            if (!currentUserId) {
                document.getElementById('listenResult').innerHTML = '<span class="error">‚ùå Please enter current user ID</span>';
                return;
            }
            
            // Stop any existing listener
            if (unsubscribe) {
                unsubscribe();
            }
            
            try {
                const incomingCallRef = database.ref(`calls/${currentUserId}/incoming`);
                
                unsubscribe = incomingCallRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    console.log('Firebase data changed:', data);
                    
                    if (data) {
                        currentCallData = data;
                        if (data.status === 'ringing') {
                            document.getElementById('listenResult').innerHTML = 
                                '<span class="info">üì• Incoming call detected:</span><br>' +
                                '<strong>Caller:</strong> ' + (data.callerName || data.callerId) + '<br>' +
                                '<strong>Type:</strong> ' + data.callType + '<br>' +
                                '<strong>Time:</strong> ' + new Date(data.timestamp).toLocaleString() + '<br>' +
                                '<strong>Status:</strong> ' + data.status + '<br>' +
                                '<div style="margin-top: 10px; padding: 10px; background: #e8f4fd; border-radius: 5px;">' +
                                '<strong>Call Data:</strong><br>' +
                                '<pre>' + JSON.stringify(data, null, 2) + '</pre>' +
                                '</div>';
                        } else {
                            document.getElementById('listenResult').innerHTML = 
                                '<span class="info">üìû Call status update:</span> ' + data.status;
                        }
                    } else {
                        currentCallData = null;
                        document.getElementById('listenResult').innerHTML = 'üì≠ No active calls';
                    }
                }, (error) => {
                    document.getElementById('listenResult').innerHTML = '<span class="error">‚ùå Firebase listener error: ' + error.message + '</span>';
                    console.error('Firebase listener error:', error);
                });
                
                document.getElementById('listenResult').innerHTML = '<span class="success">‚úÖ Listening for incoming calls...</span>';
            } catch (error) {
                document.getElementById('listenResult').innerHTML = '<span class="error">‚ùå Error setting up listener: ' + error.message + '</span>';
                console.error('Error setting up listener:', error);
            }
        });

        document.getElementById('stopListening').addEventListener('click', () => {
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
                document.getElementById('listenResult').innerHTML = 'üîá Stopped listening for calls';
            } else {
                document.getElementById('listenResult').innerHTML = '‚ö†Ô∏è Not currently listening';
            }
        });

        document.getElementById('acceptCall').addEventListener('click', async () => {
            await updateCallStatus('accepted');
        });

        document.getElementById('declineCall').addEventListener('click', async () => {
            await updateCallStatus('declined');
        });

        async function updateCallStatus(status) {
            if (!database) {
                document.getElementById('actionResult').innerHTML = '<span class="error">‚ùå Firebase not initialized</span>';
                return;
            }
            
            if (!currentCallData) {
                document.getElementById('actionResult').innerHTML = '<span class="error">‚ùå No active call to update</span>';
                return;
            }
            
            const currentUserId = document.getElementById('currentUserId').value;
            if (!currentUserId) {
                document.getElementById('actionResult').innerHTML = '<span class="error">‚ùå Please enter current user ID</span>';
                return;
            }
            
            try {
                // Update the call status
                const updatedSignal = { ...currentCallData, status: status };
                await database.ref(`calls/${currentUserId}/incoming`).set(updatedSignal);
                
                document.getElementById('actionResult').innerHTML = 
                    '<span class="success">‚úÖ Call status updated to: ' + status + '</span>';
                
                // Clean up after a delay if call is no longer ringing
                if (status !== 'ringing') {
                    setTimeout(async () => {
                        try {
                            await database.ref(`calls/${currentUserId}/incoming`).remove();
                            document.getElementById('actionResult').innerHTML += '<br><span class="info">üßπ Call data cleaned up</span>';
                        } catch (error) {
                            console.warn('Cleanup error:', error);
                        }
                    }, 2000);
                }
            } catch (error) {
                document.getElementById('actionResult').innerHTML = '<span class="error">‚ùå Error updating call status: ' + error.message + '</span>';
                console.error('Error updating call status:', error);
            }
        }
    </script>
</body>
</html>