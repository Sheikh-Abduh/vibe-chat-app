
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- User Collection Rules (/users/{userId}) ---
    match /users/{userId} {
      // READ: Any authenticated user can read any user's profile data.
      allow get, list: if isAuthenticated();

      // CREATE: A user can only create their own user document.
      allow create: if isOwner(userId);

      // UPDATE: A user can only update their own user document.
      // Allow updates to profileDetails and muteSettings fields
      allow update: if isOwner(userId) &&
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['profileDetails']) ||
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['muteSettings']) ||
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['profileDetails', 'muteSettings']) ||
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName', 'photoURL']));

      // DELETE: Disable client-side deletion for security.
      allow delete: if false;

      // --- Activity Subcollection Rules (/users/{userId}/activityItems/{activityId}) ---
      match /activityItems/{activityId} {
        // READ: A user can read their own activity items.
        allow get, list: if isOwner(userId);

        // CREATE: Allows users to create notifications for other users.
        // For connection requests: sender creates notification for recipient
        // For connection responses: recipient creates notification for sender
        // For new messages: sender creates notification for recipient
        // For mentions: sender creates notification for mentioned users
        allow create: if isAuthenticated() &&
                         ( (request.resource.data.actorId == request.auth.uid &&
                            (request.resource.data.type == 'connection_request' || 
                             request.resource.data.type == 'connection_response' ||
                             request.resource.data.type == 'new_follower' || 
                             request.resource.data.type == 'connection_accepted' ||
                             request.resource.data.type == 'new_message' ||
                             request.resource.data.type == 'mention')) ||
                           (request.resource.data.type == 'connection_request' && 
                            request.resource.data.targetUserId == userId) ||
                           (request.resource.data.type == 'connection_response' && 
                            request.resource.data.targetUserId == userId) ||
                           (request.resource.data.type == 'new_message' && 
                            request.resource.data.targetUserId == userId) ||
                           (request.resource.data.type == 'mention' && 
                            request.resource.data.targetUserId == userId)
                         );

        // UPDATE: A user can only update their own notifications.
        // 1. To mark a notification as read (isRead becomes true).
        // 2. To update notification status.
        allow update: if isOwner(userId) &&
                         ( (request.resource.data.isRead == true && resource.data.isRead == false) ||
                           (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'contentSnippet']))
                         );

        // DELETE: A user can delete their own activity items (for connection request handling).
        allow delete: if isOwner(userId);
      }
    }

    // --- Connection Requests Collection Rules (/connectionRequests/{requestId}) ---
    match /connectionRequests/{requestId} {
      // READ: Users can read connection requests they sent or received.
      allow get, list: if isAuthenticated() &&
                         (resource.data.fromUserId == request.auth.uid || 
                          resource.data.toUserId == request.auth.uid);

      // CREATE: A user can create a connection request if they are the sender.
      allow create: if isAuthenticated() &&
                       request.resource.data.fromUserId == request.auth.uid &&
                       request.resource.data.fromUserId != request.resource.data.toUserId;

      // UPDATE: Users can update connection requests they sent or received.
      // This allows updating status (pending -> accepted/rejected) and adding respondedAt timestamp.
      allow update: if isAuthenticated() &&
                       (resource.data.fromUserId == request.auth.uid || 
                        resource.data.toUserId == request.auth.uid) &&
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'respondedAt']) ||
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['respondedAt']));

      // DELETE: Disable client-side deletion.
      allow delete: if false;
    }

    // --- Communities Collection Rules (/communities/{communityId}) ---
    match /communities/{communityId} {
      // READ: Any authenticated user can read community and channel metadata.
      allow read: if isAuthenticated();
      // WRITE: Disable client-side creation/modification of communities.
      allow write: if false;

      // --- Channels Subcollection ---
      match /channels/{channelId} {
        allow read: if isAuthenticated();
        allow write: if false;

        // --- Messages Subcollection ---
        match /messages/{messageId} {
          // READ: Any authenticated user can read messages in any public channel.
          allow read: if isAuthenticated();

          // CREATE: A user can only create messages where they are the sender.
          allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;

          // UPDATE: Sender can update text. Any user can update reactions or pin status.
          allow update: if isAuthenticated() &&
                         ( (resource.data.senderId == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['text'])) ||
                           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isPinned']) ||
                           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions'])
                         );

          // DELETE: Only the user who sent the message can delete it.
          allow delete: if isAuthenticated() && resource.data.senderId == request.auth.uid;
        }
      }
    }

    // --- Direct Messages Collection Rules (/direct_messages/{conversationId}) ---
    match /direct_messages/{conversationId} {
      // READ: Users can only read conversation documents they are participants in
      allow get: if isAuthenticated() && 
                   (resource.data.participants.hasAny([request.auth.uid]) ||
                    request.auth.uid in resource.data.participants);
      
      // LIST: Users can list conversations they are participants in
      allow list: if isAuthenticated();

      // CREATE: Users can create conversations if they are a participant in the request data
      allow create: if isAuthenticated() && 
                      (request.resource.data.participants.hasAny([request.auth.uid]) ||
                       request.auth.uid in request.resource.data.participants);

      // UPDATE: Users can update conversations they are participants in
      allow update: if isAuthenticated() && 
                      (resource.data.participants.hasAny([request.auth.uid]) ||
                       request.auth.uid in resource.data.participants);

      // DELETE: Users can delete conversations they are participants in
      allow delete: if isAuthenticated() && 
                      (resource.data.participants.hasAny([request.auth.uid]) ||
                       request.auth.uid in resource.data.participants);

      // --- Messages Subcollection (/direct_messages/{conversationId}/messages/{messageId}) ---
      match /messages/{messageId} {
        // READ: Users can read messages in conversations they are participants in
        allow read: if isAuthenticated() && 
                     (get(/databases/$(database)/documents/direct_messages/$(conversationId)).data.participants.hasAny([request.auth.uid]) ||
                      request.auth.uid in get(/databases/$(database)/documents/direct_messages/$(conversationId)).data.participants);

        // CREATE: Users can create messages in conversations they are participants in
        allow create: if isAuthenticated() && 
                        (get(/databases/$(database)/documents/direct_messages/$(conversationId)).data.participants.hasAny([request.auth.uid]) ||
                         request.auth.uid in get(/databases/$(database)/documents/direct_messages/$(conversationId)).data.participants) &&
                        request.resource.data.senderId == request.auth.uid;

        // UPDATE: Users can update their own messages or mark messages as read
        allow update: if isAuthenticated() && 
                        (get(/databases/$(database)/documents/direct_messages/$(conversationId)).data.participants.hasAny([request.auth.uid]) ||
                         request.auth.uid in get(/databases/$(database)/documents/direct_messages/$(conversationId)).data.participants) &&
                        (resource.data.senderId == request.auth.uid ||
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) ||
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy', 'reactions']));

        // DELETE: Users can delete their own messages in conversations they are participants in
        allow delete: if isAuthenticated() && 
                        (get(/databases/$(database)/documents/direct_messages/$(conversationId)).data.participants.hasAny([request.auth.uid]) ||
                         request.auth.uid in get(/databases/$(database)/documents/direct_messages/$(conversationId)).data.participants) &&
                        resource.data.senderId == request.auth.uid;
      }
    }
  }
}
